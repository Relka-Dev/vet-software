{% extends "appointment/base.html" %}
{% block title %}
  Calendrier
{% endblock title %}
{% block calendar_content %}
  <div class="bg-white rounded-lg shadow mb-6 p-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <a href="{% url 'calendar_date' prev_day.year prev_day.month prev_day.day %}"
         class="p-2 hover:bg-gray-100 rounded"
         aria-label="Jour précédent">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </a>
      <a href="{% url 'calendar_date' next_day.year next_day.month next_day.day %}"
         class="p-2 hover:bg-gray-100 rounded"
         aria-label="Jour suivant">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </a>
      <a href="{% url 'calendar' %}"
         class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Aujourd'hui</a>
      <h2 class="text-xl font-semibold ml-4">{{ selected_date|date:"d F Y" }}</h2>
    </div>
    <div class="flex gap-2">
      <button class="px-4 py-2 bg-blue-600 text-white rounded">Jour</button>
      <button class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Liste</button>
    </div>
  </div>
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="border-b border-gray-200 p-4 bg-gray-50">
      <span class="text-sm text-gray-600">Toute la journée</span>
    </div>
    {% for hour in hours %}
      <div class="border-b border-gray-200 h-16 flex items-start p-2 hover:bg-gray-50">
        <span class="text-sm text-gray-600 w-20">{{ hour }}:00</span>
        <div class="flex-1 ml-4">
          {% for item in appointments %}
            {% if item.appointment.start_date.day == selected_date.day and item.appointment.start_date.hour == hour %}
              <div class="flex justify-between bg-blue-600 text-white rounded p-2 text-sm mb-2 cursor-pointer hover:bg-blue-700"
                   style="min-height: {{ item.height_px }}px">
                <div>
                  <div class="font-semibold">{{ item.appointment.emergency_type.name }} - {{ item.appointment.animal.name }} {{ item.appointment.animal.family.main_contact.last_name }} ({{ item.appointment.animal.species.name }})</div>
                  <div class="text-xs opacity-90">
                    {{ item.appointment.start_date|date:"H:i" }} - {{ item.appointment.end_date|date:"H:i" }}
                    • {{ item.appointment.employee.person.first_name }} {{ item.appointment.employee.person.last_name }}
                  </div>
                  <a href="{% url 'appointment_details' pk=item.appointment.pk %}"
                     class="font-medium text-white hover:underline">voir détails</a>
                </div>
                <div class="px-6 py-4 text-right">
                  <button onclick="toggleModal('edit-appointment-{{ item.appointment.id }}')"
                          class="font-medium text-white hover:underline">Edit</button>
                </div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
    {% endfor %}
  </div>
  <!-- Modal d'ajout -->
  <div id="new-appointment"
       tabindex="-1"
       aria-hidden="true"
       class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <div class="relative p-4 bg-white rounded-lg shadow-sm">
        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
          <h3 class="text-lg font-semibold text-gray-900">Créer un nouveau rendez-vous</h3>
          <button type="button"
                  onclick="toggleModal('new-appointment')"
                  class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
            <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
            </svg>
          </button>
        </div>
        <form method="post" action="{% url 'add_appointment' %}" class="p-4 md:p-5">
          {% csrf_token %}
          <div class="grid gap-4 mb-4 grid-cols-2">
            <div class="col-span-2">
              <label for="animal" class="block mb-2 text-sm font-medium text-gray-900">Animal</label>
              <select name="animal"
                      id="animal"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                      required>
                <option value="">Sélectionner un animal</option>
                {% for animal in animals %}<option value="{{ animal.id }}">{{ animal.name }} {{ animal.family.main_contact.last_name }} ({{ animal.species.name }})</option>{% endfor %}
              </select>
            </div>
            <div class="col-span-2">
              <label for="room" class="block mb-2 text-sm font-medium text-gray-900">Salle</label>
              <select name="room"
                      id="room"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                      required>
                <option value="">Sélectionner une salle</option>
                {% for room in rooms %}<option value="{{ room.id }}">{{ room.room_type.name }}</option>{% endfor %}
              </select>
            </div>
             <!-- Champ employé : visible seulement pour réception, caché sinon -->
              {% if is_reception %}
                <div class="col-span-2">
                  <label for="employee" class="block mb-2 text-sm font-medium text-gray-900">Employé</label>
                  <select name="employee"
                          id="employee"
                          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                          required>
                    <option value="">Sélectionner un employé</option>
                    {% for emp in employees %}
                      <option value="{{ emp.id }}">{{ emp.person.get_full_name }} - {{ emp.role.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% else %}
                <!-- Pour non-réception : champ caché avec l'employé connecté -->
                <input type="hidden" name="employee" value="{{ current_employee.id }}">
                <div class="col-span-2">
                  <label class="block mb-2 text-sm font-medium text-gray-900">Employé</label>
                  <div class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                    {{ current_employee.person.get_full_name }} - {{ current_employee.role.name }}
                  </div>
                </div>
              {% endif %}
            <div class="col-span-2">
              <label for="emergency_type"
                     class="block mb-2 text-sm font-medium text-gray-900">Type de consultation</label>
              <select name="emergency_type"
                      id="emergency_type"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                      required>
                <option value="">Sélectionner un type</option>
                {% for type in emergency_types %}<option value="{{ type.id }}">{{ type.name }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-span-2 sm:col-span-1">
              <label for="start_date" class="block mb-2 text-sm font-medium text-gray-900">Date de début</label>
              <input type="datetime-local"
                     name="start_date"
                     id="start_date"
                     class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                     required>
            </div>
            <div class="col-span-2 sm:col-span-1">
              <label for="end_date" class="block mb-2 text-sm font-medium text-gray-900">Date de fin</label>
              <input type="datetime-local"
                     name="end_date"
                     id="end_date"
                     class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                     required>
            </div>
          </div>
          <button type="submit"
                  class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
            <svg class="me-1 -ms-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd">
              </path>
            </svg>
            Ajouter le rendez-vous
          </button>
        </form>
      </div>
    </div>
  </div>
  <!-- Modals de modification (en dehors de la boucle) -->
  {% for item in appointments %}
    <div id="edit-appointment-{{ item.appointment.id }}"
         tabindex="-1"
         aria-hidden="true"
         class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
      <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative p-4 bg-white rounded-lg shadow-sm">
          <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
            <h3 class="text-lg font-semibold text-gray-900">Modifier le rendez-vous</h3>
            <button type="button"
                    onclick="toggleModal('edit-appointment-{{ item.appointment.id }}')"
                    class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center">
              <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
              </svg>
            </button>
          </div>
          <form method="post"
                action="{% url 'update_appointment' pk=item.appointment.pk %}"
                class="p-4 md:p-5">
            {% csrf_token %}
            <div class="grid gap-4 mb-4 grid-cols-2">
              <div class="col-span-2">
                <label class="block mb-2 text-sm font-medium text-gray-900">Animal</label>
                <select name="animal"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                  {% for animal in animals %}
                    <option value="{{ animal.id }}"
                            {% if animal.id == item.appointment.animal.id %}selected{% endif %}>
                      {{ animal.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-span-2">
                <label class="block mb-2 text-sm font-medium text-gray-900">Salle</label>
                <select name="room"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                  {% for room in rooms %}
                    <option value="{{ room.id }}"
                            {% if room.id == item.appointment.room.id %}selected{% endif %}>
                      {{ room.room_type.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-span-2">
                <label class="block mb-2 text-sm font-medium text-gray-900">Employé</label>
                <select name="employee"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                  {% for emp in employees %}
                    <option value="{{ emp.id }}"
                            {% if emp.id == item.appointment.employee.id %}selected{% endif %}>
                      {{ emp.person.get_full_name }} - {{ emp.role.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-span-2">
                <label class="block mb-2 text-sm font-medium text-gray-900">Type de consultation</label>
                <select name="emergency_type"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                  {% for type in emergency_types %}
                    <option value="{{ type.id }}"
                            {% if type.id == item.appointment.emergency_type.id %}selected{% endif %}>
                      {{ type.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-span-2 sm:col-span-1">
                <label class="block mb-2 text-sm font-medium text-gray-900">Date de début</label>
                <input type="datetime-local"
                       name="start_date"
                       value="{{ item.appointment.start_date|date:'Y-m-d\TH:i' }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
              </div>
              <div class="col-span-2 sm:col-span-1">
                <label class="block mb-2 text-sm font-medium text-gray-900">Date de fin</label>
                <input type="datetime-local"
                       name="end_date"
                       value="{{ item.appointment.end_date|date:'Y-m-d\TH:i' }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <button type="submit"
                      name="edit-button"
                      class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Modifier
              </button>
              <button type="submit"
                      name="delete-button"
                      class="text-red-600 inline-flex items-center hover:text-white border border-red-600 hover:bg-red-600 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                <svg class="mr-1 -ml-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd">
                  </path>
                </svg>
                Supprimer
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
  <script>
  function toggleModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.toggle('hidden');
    modal.classList.toggle('flex');
  }
  </script>
{% endblock calendar_content %}
